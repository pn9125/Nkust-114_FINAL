@model WebApp.ViewModels.BirthIndexViewModel

@{
    ViewData["Title"] = "日本出生人數統計";
}

<div class="container mt-5">
    <h1 class="mb-4">日本出生人數統計 (男女性別)</h1>

    <!-- Search Section -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            資料查詢與統計
        </div>
        <div class="card-body">
            <form asp-action="Index" method="get" class="row g-3 align-items-end">
                <div class="col-auto">
                    <label for="searchYear" class="form-label">輸入年份</label>
                    <input type="number" class="form-control" name="searchYear" id="searchYear" value="@Model.SearchYear" placeholder="例如: 2010">
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-primary">查詢</button>
                    <a asp-action="Index" class="btn btn-secondary">顯示全部</a>
                </div>
            </form>

            @if (Model.SelectedData != null)
            {
                <div class="mt-4 p-3 bg-light border rounded">
                    <h5>查詢結果: @Model.SelectedData.Year 年</h5>
                    <p>男性: @Model.SelectedData.Male.ToString("N0") | 女性: @Model.SelectedData.Female.ToString("N0") | 總計: @Model.SelectedData.Total.ToString("N0")</p>
                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                            <h6>前年到該年 (@(Model.SelectedData.Year - 2) - @Model.SelectedData.Year)</h6>
                            <p class="fs-5">標準差: <span class="badge bg-info text-dark">@(Model.StdDevPrev?.ToString("F2") ?? "N/A")</span></p>
                        </div>
                        <div class="col-md-6">
                            <h6>該年到後年 (@Model.SelectedData.Year - @(Model.SelectedData.Year + 2))</h6>
                            <p class="fs-5">標準差: <span class="badge bg-warning text-dark">@(Model.StdDevNext?.ToString("F2") ?? "N/A")</span></p>
                        </div>
                    </div>
                </div>
            }
            else if (Model.SearchYear.HasValue)
            {
                <div class="alert alert-warning mt-3">找不到年份 @Model.SearchYear 的資料</div>
            }
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            趨勢圖
        </div>
        <div class="card-body">
            <canvas id="birthChart" width="400" height="200"></canvas>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            數據列表
        </div>
        <div class="card-body">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>年份</th>
                        <th>男性出生數</th>
                        <th>女性出生數</th>
                        <th>總計</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.DataList)
                    {
                        <tr class="@(Model.SearchYear == item.Year ? "table-primary" : "")">
                            <td>@item.Year</td>
                            <td>@item.Male.ToString("N0")</td>
                            <td>@item.Female.ToString("N0")</td>
                            <td>@item.Total.ToString("N0")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var ctx = document.getElementById('birthChart').getContext('2d');
            
            var years = @Html.Raw(Json.Serialize(Model.DataList.Select(m => m.Year)));
            var maleData = @Html.Raw(Json.Serialize(Model.DataList.Select(m => m.Male)));
            var femaleData = @Html.Raw(Json.Serialize(Model.DataList.Select(m => m.Female)));

            var chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [
                        {
                            label: '男性出生數',
                            data: maleData,
                            borderColor: 'blue',
                            borderWidth: 2,
                            fill: false
                        },
                        {
                            label: '女性出生數',
                            data: femaleData,
                            borderColor: 'pink',
                            borderWidth: 2,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '年份'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '出生人數'
                            }
                        }
                    }
                }
            });
        });
    </script>
}
